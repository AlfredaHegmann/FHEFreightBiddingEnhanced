name: Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'sepolia'
        type: choice
        options:
          - sepolia
          - mainnet

jobs:
  # ============================================================
  # DEPLOY SMART CONTRACTS
  # ============================================================
  deploy-contracts:
    name: Deploy Smart Contracts
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'sepolia' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Deploy to Sepolia
        if: ${{ github.event.inputs.environment == 'sepolia' || github.ref == 'refs/heads/main' }}
        env:
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          SEPOLIA_DEPLOYER_PRIVATE_KEY: ${{ secrets.SEPOLIA_DEPLOYER_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: |
          npm run deploy:sepolia
          echo "âœ… Deployed to Sepolia"

      - name: Verify contracts
        if: success()
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: |
          npm run verify
          echo "âœ… Contracts verified on Etherscan"

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contract-deployment-${{ github.sha }}
          path: |
            deployments/
            artifacts/

  # ============================================================
  # DEPLOY FRONTEND TO VERCEL
  # ============================================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-contracts
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: freight-bidding-platform

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: freight-bidding-platform
        env:
          NEXT_PUBLIC_CONTRACT_ADDRESS: ${{ secrets.CONTRACT_ADDRESS }}
          NEXT_PUBLIC_CHAIN_ID: ${{ secrets.CHAIN_ID }}
          NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID: ${{ secrets.WALLETCONNECT_PROJECT_ID }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to Vercel: $url"
        working-directory: freight-bidding-platform

      - name: Comment deployment URL
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Deployment Complete\n\n**Frontend:** ${{ steps.deploy.outputs.url }}\n**Environment:** Production\n**Commit:** ${context.sha.substring(0, 7)}`
            });

  # ============================================================
  # CREATE RELEASE
  # ============================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [deploy-contracts, deploy-frontend]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          name: contract-deployment-${{ github.sha }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            deployments/**/*
            LICENSE
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
